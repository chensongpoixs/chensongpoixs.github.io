---
layout:     post
title:      redis源码分析之跳跃表
subtitle:   skiplist, ziplist
date:       2019-04-15
times:      00::05::03
author:     chensong
header-img: img/2019-02-02/bg_socketopt.jpg
catalog: 	 true
tags:
    - Redis源码探秘
    - 数据结构
---


## 前言

跳跃表数据结构可以 与平衡树和红黑树查询效率。 正常时间复杂度是O(logn), 最差时间复杂度是O(n)

skiplist原理介绍

![](https://github.com/chensongpoixs/chensongpoixs.github.io/blob/master/img/2019-04-15/skiplist.png?raw=true)



这样所有新增加的指针连成了一个新的链表，但它包含的节点个数只有原来的一半（上图中是9, 45, 99）。现在当我们想查找数据的时候，可以先沿着这个新链表进行查找。当碰到比待查数据大的节点时，再回到原来的链表中进行查找。比如，我们想查找55，查找的路径是沿着下图中标红的指针所指向的方向进行的：

![](https://github.com/chensongpoixs/chensongpoixs.github.io/blob/master/img/2019-04-15/skiplist_find_.png?raw=true)

1. 55首先和9比较，再和45比较，比它们都大，继续向后比较。

2. 但55和99比较的时候，比99要小，因此回到下面的链表（原链表），与67比较。

3. 55比67要小，沿下面的指针继续向前和45比较。55比45大，说明待查数据55在原链表中不存在，而且它的插入位置应该在45和67之间。

## 正文

```
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
```


这个配置的意思是说，在如下两个条件之一满足的时候，ziplist会转成zset（具体的触发条件参见t_zset.c中的zaddGenericCommand相关代码）：

1. 当sorted set中的元素个数，即(数据, score)对的数目超过128的时候，也就是ziplist数据项超过256的时候。
2. 当sorted set中插入的任意一个数据的长度超过了64的时候。

## 结语