---
layout:     post
title:      redis源码之内存管理源码分析
subtitle:   内存设计原理分析
date:       2019-03-22
times:      22::48::45
author:     chensong
header-img: img/2018-12-22/bg_cycle.jpg
catalog: 	 true
tags:
    - Redis源码探秘
---

## 前言

redis源码只有23000行代码, 可以说压缩的代码非常经典, 以最少代码写出存储管理

## 正文

### 一, redis 中内存管理


redis中提供接口有

```
void *zmalloc(size_t size);
void *zcalloc(size_t size);
void *zrealloc(void *ptr, size_t size);
void zfree(void *ptr);
char *zstrdup(const char *s);
//已经使用内存的大小
size_t zmalloc_used_memory(void);
void zmalloc_enable_thread_safeness(void);
void zmalloc_set_oom_handler(void (*oom_handler)(size_t));
float zmalloc_get_fragmentation_ratio(size_t rss);
// 获取
size_t zmalloc_get_rss(void);
size_t zmalloc_get_private_dirty(void);
size_t zmalloc_get_smap_bytes_by_field(char *field);
void zlibc_free(void *ptr);

#ifndef HAVE_MALLOC_SIZE
size_t zmalloc_size(void *ptr);
#endif
```


zmalloc(size)在分配内存的时候会多申请sizeof(size_t)个字节大小的内存
【64位系统中是8字节】，即调用malloc(size+8)，
所以一共申请分配size+8个字节，zmalloc(size)会在已分配内存的首地址开始的8字节
中存储size的值，实际上因为内存对齐，malloc(size+8)分配的内存可能会比size+8要多一些，
目的是凑成8的倍数，所以实际分配的内存大小是size+8+X【(size+8+X)%8==0 (0<=X<=7)】。
然后内存指针会向右偏移8个字节的长度。zfree()就是zmalloc()的一个逆操作，
而zmalloc_size()的目的就是计算出size+8+X的总大小


```
size&(sizeof(long) - 1)
```



## 结语
